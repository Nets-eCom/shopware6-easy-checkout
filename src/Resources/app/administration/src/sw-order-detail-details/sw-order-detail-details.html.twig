{% block sw_order_detail_details_payment %}
  <template v-if="!isNexiCheckoutPayment">
    {% parent %}
  </template>

  <template v-else>
    {% block nexi_checkout_payment_component %}
      <mt-card
        :title="$tc('nexi-checkout-payment-component.payment-details.title')"
        :isLoading="isLoading"
        :key="reloadKey"
      >
        <div class="nexi-checkout-details__header-wrapper">
          <div>
            <p class="nexi-checkout-details__status-text">
              {{ $tc('nexi-checkout-payment-component.payment-details.status-label') }}
            </p>
            <sw-label
              :variant="statusVariant"
              size="default"
              appearance="pill"
              class="nexi-checkout-details__status-label">
              {{ $tc(statusTcString) }}
            </sw-label>
          </div>
          <div class="nexi-checkout-details__history-link">
            <sw-internal-link
              :routerLink="undefined"
              :inline="false"
              :hideIcon="true"
              @click="showStateHistoryModal = true"
            >
              {{ $tc('nexi-checkout-payment-component.payment-details.history-link') }}
            </sw-internal-link>
          </div>
        </div>
        <sw-container columns="1fr 1fr" class="nexi-checkout-details__main-wrapper">

          {% block sw_order_detail_details_payment_billing_address %}
            <sw-order-address-selection
              class="sw-order-detail-details__billing-address"
              type="billing"
              :address="billingAddress"
              :address-id="selectedBillingAddressId"
              :disabled="!acl.can('order.editor') || undefined"
              :label="$tc('sw-order.createBase.detailsBody.labelBillingAddress')"
              @change-address="onChangeOrderAddress"
            />
          {% endblock %}

          {% block sw_order_detail_details_payment_method_select %}
            <sw-entity-single-select
              v-model:value="transaction.paymentMethodId"
              entity="payment_method"
              label-property="distinguishableName"
              disabled
              :criteria="paymentMethodCriteria"
              :label="$tc('sw-order.createBase.detailsFooter.labelPaymentMethod')"
              :placeholder="$tc('sw-order.createBase.detailsFooter.placeholderPaymentMethod')"
              show-clearable-button
            />
          {% endblock %}

          {% block nexi_checkout_payment_component_payment_details %}
            <template v-if="!hasFetchError">
              <div>
                <mt-text-field
                  :label="$tc('nexi-checkout-payment-component.payment-details.payment-via')"
                  :modelValue="paymentDetails.paymentVia"
                  disabled
                />
              </div>
              <div>
                <mt-text-field
                  :label="$tc('nexi-checkout-payment-component.payment-details.payment-id')"
                  :modelValue="paymentDetails.paymentId"
                  disabled
                />
              </div>
              <div>
                <mt-text-field
                  :label="$tc('nexi-checkout-payment-component.payment-details.order-amount')"
                  :modelValue="paymentDetails.orderAmount"
                  disabled
                >
                  <template v-slot:suffix>{{ order.currency.symbol }}</template>
                </mt-text-field>
              </div>
              <div>
                <mt-text-field
                  :label="$tc('nexi-checkout-payment-component.payment-details.time-order')"
                  :modelValue="paymentDetails.orderTime"
                  type="date"
                  disabled
                >
                  <template v-slot:suffix>
                    <mt-icon name="regular-calendar"/>
                  </template>
                </mt-text-field>
              </div>
              <div v-if="!isNewPayment">
                <mt-text-field
                  :label="$tc('nexi-checkout-payment-component.payment-details.charged-amount')"
                  :modelValue="paymentDetails.chargedAmount"
                  disabled
                  :helpText="$tc('nexi-checkout-payment-component.payment-details.charged-help-text')"
                >
                  <template v-slot:suffix>{{ order.currency.symbol }}</template>
                </mt-text-field>
              </div>
              <div v-if="shouldDisplayRefundField">
                <mt-text-field
                  :label="$tc('nexi-checkout-payment-component.payment-details.refunded-amount')"
                  :modelValue="paymentDetails.refundedAmount"
                  disabled
                  :helpText="$tc('nexi-checkout-payment-component.payment-details.refunded-help-text')"
                >
                  <template v-slot:suffix>{{ order.currency.symbol }}</template>
                </mt-text-field>
              </div>
            </template>
          {% endblock %}
        </sw-container>
        {% block nexi_checkout_payment_component_footer %}
          <template #footer>
            <div class="nexi-checkout-details__action-buttons" v-if="shouldDisplayButtonsSection">
                <mt-button
                  size="default"
                  :isLoading="isLoading"
                  @click="toggleCancelModal"
                  variant="secondary"
                >
                  {{ $tc('nexi-checkout-payment-component.cancel.button-title') }}
                </mt-button>

                <mt-button
                  size="default"
                  v-if="shouldDisplayRefundBtn"
                  :isLoading="isLoading"
                  @click="toggleRefundModal"
                  variant="secondary"
                >
                  {{ $tc('nexi-checkout-payment-component.refund.button-title') }}
                </mt-button>

                <mt-button
                  size="default"
                  v-if="shouldDisplayChargeBtn"
                  :isLoading="isLoading"
                  @click="toggleChargeModal"
                  variant="secondary"
                >
                  {{ $tc('nexi-checkout-payment-component.charge.button-title') }}
                </mt-button>
            </div>
          </template>
        {% endblock %}
        {% block nexi_checkout_charge_modal %}
          <sw-modal
            v-if="isChargeModalVisible"
            :title="$tc('nexi-checkout-payment-component.charge.title')"
            @modal-close="toggleChargeModal"
          >
            <p>{{ $tc('nexi-checkout-payment-component.charge.info', { orderNumber: order.orderNumber }) }}</p>
            <div class="nexi-checkout-modal__wrapper">
              <div>
                <mt-number-field
                  class="nexi-checkout-modal__input"
                  :label="$tc('nexi-checkout-payment-component.payment-details.charged-amount')"
                  v-model="charge.amount"
                  :min="0"
                  :digits="2"
                  numberType="float"
                  :allowEmpty="false"
                  :fillDigits="true"
                  :disabled="isItemsListVisible"
                  :error="chargeAmountError"
                >
                  <template v-slot:suffix>{{ order.currency.symbol }}</template>
                </mt-number-field>
                <p class="nexi-checkout-modal__full-amount">
                  {{ $tc('nexi-checkout-payment-component.charge.max-charge-info') }}
                  <span
                    @click="onClickMaxCharge"
                    data-testid="maxChargeBtn"
                  >
                    {{ order.currency.symbol + paymentDetails.remainingChargeAmount }}
                  </span>
                </p>
              </div>
              <mt-checkbox
                class="nexi-checkout-modal__checkbox"
                :class="{ 'error-margin': chargeAmountError }"
                :checked="isItemsListVisible"
                @update:checked="isItemsListVisible = $event"
                :label="$tc('nexi-checkout-payment-component.charge.items-list')"
              >
              </mt-checkbox>
            </div>
            <div v-if="isItemsListVisible" class="nexi-checkout-modal__items-list">
              <sw-grid :selectable="false" :items="paymentDetails.orderItems">
                <template #columns="{ item }">
                  <sw-grid-column
                    flex="minmax(50px, 1.3fr)"
                    class="nexi-checkout-modal__end-col"
                    :label="$tc('nexi-checkout-payment-component.itemsTable.qty')"
                  >
                    {{ item.quantity }}x
                  </sw-grid-column>
                  <sw-grid-column
                    flex="minmax(200px, 4.3fr)"
                    :label="$tc('nexi-checkout-payment-component.itemsTable.item')"
                  >
                    {{ item.name }}
                  </sw-grid-column>
                  <sw-grid-column
                    flex="minmax(100px, 2.1fr)"
                    class="nexi-checkout-modal__end-col"
                    :label="$tc('nexi-checkout-payment-component.itemsTable.subtotal')"
                  >
                    {{ order.currency.symbol + item.grossTotalAmount }}
                  </sw-grid-column>
                  <sw-grid-column
                    flex="minmax(100px, 2.3fr)"
                    :label="$tc('nexi-checkout-payment-component.itemsTable.chargeQty')"
                    class="nexi-checkout-modal__qty-col"
                  >
                    <mt-select
                      v-model="item.chargeQuantity"
                      placeholder="0"
                      class="nexi-checkout-modal__qty-select"
                      @update:modelValue="quantity => updateChargeItem(item, quantity)"
                      :options="getChargeQtyOptions(item)"
                    />
                  </sw-grid-column>
                </template>
              </sw-grid>
            </div>
            <template #modal-footer>
              <mt-button
                size="default"
                @click="toggleChargeModal"
                class="nexi-checkout-modal__btn"
                variant="secondary"
              >
                {{ $tc('nexi-checkout-payment-component.cancel.button-action-title') }}
              </mt-button>
              <mt-button
                size="default"
                @click="handleCharge"
                class="nexi-checkout-modal__btn"
                :isLoading="isLoading"
                variant="primary"
                :disabled="chargeAmountError">
                {{ $tc('nexi-checkout-payment-component.charge.button-title') }}
              </mt-button>
            </template>
          </sw-modal>
        {% endblock %}

        {% block nexi_checkout_refund_modal %}
          <sw-modal
            v-if="isRefundModalVisible"
            :title="$tc('nexi-checkout-payment-component.refund.title')"
            @modal-close="toggleRefundModal"
          >
            <p>{{ $tc('nexi-checkout-payment-component.refund.info', { orderNumber: order.orderNumber }) }}</p>
            <div class="nexi-checkout-modal__wrapper">
              <div>
                <mt-number-field
                  class="nexi-checkout-modal__input"
                  :label="$tc('nexi-checkout-payment-component.refund.input-label')"
                  v-model="refund.amount"
                  :min="0"
                  :digits="2"
                  numberType="float"
                  :fillDigits="true"
                  :allowEmpty="false"
                  :disabled="isItemsListVisible"
                  :error="refundAmountError"
                >
                  <template v-slot:suffix>{{ order.currency.symbol }}</template>
                </mt-number-field>
                <p class="nexi-checkout-modal__full-amount">
                  {{ $tc('nexi-checkout-payment-component.refund.max-refund-info') }}
                  <span
                    @click="onClickMaxRefund"
                    data-testid="maxRefundBtn">{{ order.currency.symbol + paymentDetails.remainingRefundAmount }}
                  </span>
                </p>
              </div>
              <mt-checkbox
                class="nexi-checkout-modal__checkbox"
                :class="{ 'error-margin': refundAmountError }"
                :checked="isItemsListVisible"
                @update:checked="isItemsListVisible = $event"
                :label="$tc('nexi-checkout-payment-component.refund.items-list')"
              >
              </mt-checkbox>
            </div>
            <div v-if="isItemsListVisible" class="nexi-checkout-modal__items-list">
              <sw-grid :selectable="false" :items="paymentDetails.charges">
                <template #columns="{ item }">
                  <sw-grid-column
                    flex="minmax(50px, 1.3fr)"
                    :label="$tc('nexi-checkout-payment-component.itemsTable.qty')"
                    class="nexi-checkout-modal__end-col"
                  >
                    {{ item.quantity }}x
                  </sw-grid-column>
                  <sw-grid-column
                    flex="minmax(220px, 4.3fr)"
                    :label="$tc('nexi-checkout-payment-component.itemsTable.item')"
                  >
                    <p>{{ item.name }}<br><span class="nexi-checkout-modal__charge-id">{{ item.chargeId }}</span></p>
                  </sw-grid-column>
                  <sw-grid-column
                    flex="minmax(100px, 2.1fr)"
                    class="nexi-checkout-modal__end-col"
                    :label="$tc('nexi-checkout-payment-component.itemsTable.subtotal')"
                  >
                    {{ order.currency.symbol + item.grossTotalAmount }}
                  </sw-grid-column>
                  <sw-grid-column
                    flex="minmax(100px, 2.3fr)"
                    :label="$tc('nexi-checkout-payment-component.itemsTable.refundQty')"
                    class="nexi-checkout-modal__qty-col"
                  >
                    <mt-select
                      v-model="item.refundQuantity"
                      placeholder="0"
                      class="nexi-checkout-modal__qty-select"
                      @update:modelValue="quantity => updateRefundItem(item, quantity)"
                      :options="getRefundQtyOptions(item)"
                      size="small"
                    />
                  </sw-grid-column>
                </template>
              </sw-grid>
            </div>
            <template #modal-footer>
              <mt-button
                size="default"
                @click="toggleRefundModal"
                class="nexi-checkout-modal__btn" variant="secondary"
              >
                {{ $tc('nexi-checkout-payment-component.cancel.button-action-title') }}
              </mt-button>
              <mt-button
                size="default"
                @click="handleRefund"
                class="nexi-checkout-modal__btn"
                :isLoading="isLoading"
                variant="primary"
                :disabled="refundAmountError">
                {{ $tc('nexi-checkout-payment-component.refund.button-title') }}
              </mt-button>
            </template>
          </sw-modal>
        {% endblock %}

        {% block nexi_checkout_cancel_modal %}
          <sw-confirm-modal
            v-if="isCancelModalVisible"
            type="confirm"
            :text="$t('nexi-checkout-payment-component.cancel.confirmation', { amount: paymentDetails.orderAmount, currency: order.currency.symbol })"
            :title="$t('nexi-checkout-payment-component.cancel.title')"
            @confirm="handleCancel"
            @cancel="closeCancelModal"
            @close="closeCancelModal">
          </sw-confirm-modal>
        {% endblock %}
      </mt-card>
    {% endblock %}
  </template>
{% endblock %}